<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Workflow Graph (9 nodes)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 20px; font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { max-width: 1400px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        h1 { color: #333; margin: 0 0 10px 0; font-size: 28px; }
        .desc { color: #666; margin-bottom: 20px; }
        #graph { width: 100%; height: 600px; border: 1px solid #ddd; background: #fafafa; border-radius: 8px; }
        .node { cursor: pointer; }
        .node circle { stroke: #fff; stroke-width: 3px; transition: all 0.3s; }
        .node:hover circle { filter: brightness(1.1); }
        .node text { font-size: 12px; fill: white; text-anchor: middle; pointer-events: none; font-weight: 600; }
        .link { fill: none; stroke: #999; stroke-width: 2px; marker-end: url(#arrowhead); }
        .legend { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .legend-item { display: inline-block; margin-right: 20px; font-size: 14px; }
        .legend-color { display: inline-block; width: 16px; height: 16px; border-radius: 3px; margin-right: 6px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Workflow Graph (9 nodes)</h1>
        <div class="desc"></div>
        <svg id="graph"></svg>
        <div class="legend">
            <div class="legend-item"><span class="legend-color" style="background: #2ecc71;"></span>已完成</div>
            <div class="legend-item"><span class="legend-color" style="background: #3498db;"></span>执行中</div>
            <div class="legend-item"><span class="legend-color" style="background: gray;"></span>待执行</div>
            <div class="legend-item"><span class="legend-color" style="background: #e74c3c;"></span>失败</div>
        </div>
    </div>
    <script>
        var data = {"metadata": {"created_at": "2025-11-14T09:07:28.065084", "title": "Workflow Graph (9 nodes)", "description": "", "graph_id": "code_review_workflow"}, "nodes": [{"id": "start", "label": "start", "status": "completed", "node_type": "start", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "analyze", "label": "analyze", "status": "completed", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "test", "label": "test", "status": "completed", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "review", "label": "review", "status": "completed", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "quality_check", "label": "quality_check", "status": "completed", "node_type": "condition", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "staging", "label": "staging", "status": "completed", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "production", "label": "production", "status": "completed", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}, {"id": "rollback", "label": "rollback", "status": "pending", "node_type": "task", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#gray", "shape": null}, {"id": "end", "label": "end", "status": "completed", "node_type": "end", "metadata": {}, "start_time": null, "end_time": null, "duration": null, "agent": null, "color": "#2ecc71", "shape": null}], "edges": [{"source": "start", "target": "analyze", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "analyze", "target": "test", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "test", "target": "review", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "review", "target": "quality_check", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "quality_check", "target": "staging", "label": "质量合格", "edge_type": "conditional", "metadata": {}, "color": null, "style": "dashed"}, {"source": "quality_check", "target": "rollback", "label": "质量不合格", "edge_type": "conditional", "metadata": {}, "color": null, "style": "dashed"}, {"source": "staging", "target": "production", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "production", "target": "end", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}, {"source": "rollback", "target": "end", "label": null, "edge_type": "normal", "metadata": {}, "color": null, "style": "solid"}]};
        
        var width = document.getElementById('graph').clientWidth;
        var height = 600;
        
        var svg = d3.select("#graph").attr("viewBox", [0, 0, width, height]);
        
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#999");
        
        var simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.edges).id(function(d) { return d.id; }).distance(150))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(40));
        
        var link = svg.append("g")
            .selectAll("path")
            .data(data.edges)
            .join("path")
            .attr("class", "link");
        
        var node = svg.append("g")
            .selectAll("g")
            .data(data.nodes)
            .join("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        node.append("circle")
            .attr("r", 30)
            .attr("fill", function(d) { return d.color || "#bdc3c7"; });
        
        node.append("text")
            .attr("dy", ".35em")
            .text(function(d) { return d.id; });
        
        node.append("title")
            .text(function(d) { 
                var text = d.label + " - Status: " + d.status;
                if (d.agent) text += " - Agent: " + d.agent;
                if (d.duration) text += " - Duration: " + d.duration.toFixed(2) + "s";
                return text;
            });
        
        simulation.on("tick", function() {
            link.attr("d", function(d) {
                var dx = d.target.x - d.source.x;
                var dy = d.target.y - d.source.y;
                var dr = Math.sqrt(dx * dx + dy * dy);
                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
            });
            
            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        });
        
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    </script>
</body>
</html>